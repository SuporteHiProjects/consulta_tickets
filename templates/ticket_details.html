<!DOCTYPE html>
<html>
<head>
    <title>Detalhes do Ticket</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles.css') }}">
    <script src="../static/details_scripts.js" defer></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
      .comments-container {
          display: flex;
          flex-direction: column;
          max-width: 100%; /* Largura máxima para a área de comentários */
          margin-left: auto; /* Centralizar a área de comentários na tela */
          margin-right: auto;
      }

      .comment {
          margin-bottom: 10px;
          border-radius: 8px;
          overflow: hidden; /* Adiciona um overflow:hidden para evitar espaçamentos indesejados */
      }

      .comment-right {
          align-self: flex-end;
          max-width: 85%;
          background-color: #cee3fb; /* Cor de fundo para comentários originados de e-mails */
          padding: 10px; /* Adiciona espaçamento interno */
          margin-bottom: 10px; /* Adiciona margem inferior para separar os blocos */
      }

      .comment-left {
          align-self: flex-start;
          max-width: 85%;
          background-color: #CCD9DE; /* Cor de fundo para comentários de usuários sem e-mail */
          padding: 10px; /* Adiciona espaçamento interno */
          margin-bottom: 10px; /* Adiciona margem inferior para separar os blocos */
      }

      .comment-meta {
          font-weight: bold;
      }
  </style>
</head>
<body>
    <a href="javascript:history.back()" class="btn btn-outline-info" id="back-button"></a>
    <div class="alert alert-light" id="tickets_details_container" role="alert">
        <div class="info_headers">
            <p><span class="ticket_subject">{{ ticket_details.subject }}</span><span class="ticket_number"> #{{ ticket_details.number }}</span></p>
            <div class="info_data">
                <div class="info_row">
                    <div class="ticket_created"><i class="fa-solid fa-address-card"></i></div>
                    <div class="ticket_mail"><i class="fa-regular fa-envelope"></i></div>
                </div>
                <div class="info_row">
                    <div class="ticket_group"><i class="fa-solid fa-layer-group"></i> Grupo: {{ ticket_details.group.name }}</div>
                    <div class="ticket_analyst"><i class="fa-solid fa-building-user"></i> Responsável: {{ ticket_details.responsible.name }}</div>
                </div>
                <div class="info_row_footer">
                    {% if ticket_details.state.name == 'Finalizado' %}
                    <div class="ticket_finished">{{ ticket_details.state.name }}</div>
                    {% elif ticket_details.state.name == 'Aberto' %}
                    <div class="ticket_opened">{{ ticket_details.state.name }}</div>
                    {% elif ticket_details.state.name == 'Em andamento' %}
                    <div class="ticket_ongoing">{{ ticket_details.state.name }}</div>
                    {% elif ticket_details.state.name == 'Aguardando resposta' %}
                    <div class="ticket_waiting">{{ ticket_details.state.name }}</div>
                    {% elif ticket_details.state.name == 'Reaberto' %}
                    <div class="ticket_reopened">{{ ticket_details.state.name }}</div>
                    {% endif %}
                    <div class="ticket_sla"><i class="fa-solid fa-clock-rotate-left"></i> Prazo: {{ ticket_details.deadline }}</div>
                </div>
            </div>
        </div>
    </div>

<button type="button" id="attachmentsButton" class="btn btn-outline-primary mb-3 w-auto">Anexos</button>

      <div class="modal fade" id="attachmentsModal" tabindex="-1" aria-labelledby="attachmentsModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="attachmentsModalLabel">Anexos</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Lista de anexos -->
          <ul id="attachmentsList">
            {% for attachment in attachments %}
            <li>
              <a href="{{ url_for('download_attachment', ticket_id=ticket_details['id'], attachment_id=attachment['id']) }}"
                target="_blank">{{ attachment['name'] }}</a>
            </li>
            {% endfor %}
          </ul>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="accordion" id="accordionExample">
      <div class="accordion-item">
          <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                  data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                  <strong>Detalhes <span
                          class="position-absolute top-0 start-25 translate-middle badge rounded-pill bg-danger"
                          id="total_interactions"></span> </strong>
              </button>
          </h2>
          <div id="collapseThree" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
              <div class="accordion-body">
                  <div class="comments-container">
                      <div class="comment comment-right">
                          <p class="comment-meta">Em {{ ticket_details.creationDate | safe }},
                              {{ emailsData.MailAddress[0].Address }} abriu o ticket e escreveu:</p>
                        <p class="comment-content">{{ ticket_details.description | safe }}</p>

                      </div>
                      {% for comment in comments %}
                      <div
                          class="comment {% if comment.user.email or comment.user.name == 'Supervisor' %}comment-right{% else %}comment-left{% endif %}">
                          <p class="comment-meta">
                              {% if comment.user.name == 'Supervisor' %}
                                  Respondido via módulo consumidor em {{ comment.date }}
                              {% else %}
                                  Em {{ comment.date }}, {{ comment.user.name }} escreveu:
                              {% endif %}
                          </p>
                        <p class="comment-content">{{ comment.content | replace('\n', '<br>') | safe }}</p>
                      </div>
                      {% endfor %}
                  </div>
              </div>
          </div>
      </div>
  </div>

<button
    type="button"
    id="add_new_comment"
    class="btn btn-success"
    data-bs-toggle="modal"
    data-bs-target="#addComment"
    {% if ticket_details.state.name == 'Finalizado' %}disabled{% endif %}
    {% if ticket_details.state.name == 'Finalizado' %}
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Não é possível adicionar comentários a tickets finalizados"
    {% endif %}
>
    Adicionar comentário
</button>
    <!-- Modal -->
    <div class="modal fade" id="addComment" tabindex="-1" aria-labelledby="addCommentLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="addCommentLabel">Novo comentário</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="POST" enctype="multipart/form-data" action="/responder_ticket/{{ ticket_details.id }}">
                        <div class="first_container_datas">
                            <!--<span class="input-group-text" id="basic-addon1"><strong>Seu e-mail</strong></span>
                            <input type="text" class="form-control" name="new_comment_email" placeholder="E-mail" aria-label="email" aria-describedby="basic-addon1">
                        </div>-->
                        <div class="second_container_datas">
                            <span class="input-group-text" id="basic-addon2"><strong>Insira o comentário</strong></span>
                            <textarea id="textArea_content" class="form-control" name="new_comment_content" aria-label="ticketContent"></textarea>
                            <input type="file" class="form-control" name="new_comment_anexos[]" id="inputGroupFile01" multiple>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-outline-success">Adicionar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <script>
        var ticketsDetails_data =  {{ ticket_details | tojson | safe }};
        var commentsData = {{ comments | tojson | safe }};
        var emailsTransitData = {{ emailsData | tojson | safe }};
    </script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    var attachmentsButton = document.getElementById('attachmentsButton');
    var attachmentsModal = new bootstrap.Modal(document.getElementById('attachmentsModal'));

    attachmentsButton.addEventListener('click', function () {
      attachmentsModal.show();
    });

    // Adiciona um ouvinte de evento para detectar o fechamento do modal
    attachmentsModal._element.addEventListener('hidden.bs.modal', function () {
      // Limpa o foco após fechar o modal para evitar que a tela permaneça escura
      document.activeElement.blur();
    });
  });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Inicializa o tooltip se o botão estiver desativado (ticket finalizado)
        var addCommentButton = document.getElementById('add_new_comment');
        if (addCommentButton && addCommentButton.disabled) {
            new bootstrap.Tooltip(addCommentButton);
        }
    });
</script>
</body>
</html>